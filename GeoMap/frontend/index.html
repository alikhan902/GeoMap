<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Куда пойти — Москва глазами Артёма</title>

<link rel="shortcut icon" href="/static/favicon.png" type="image/png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
<link rel="stylesheet" href="/static/leaflet-sidebar.css"/>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/@ansur/leaflet-pulse-icon@0.1.1/dist/L.Icon.Pulse.css"/>

<style>
html, body, #map { height: 100%; margin: 0; padding: 0; }
.place-description img { max-width: 100%; }
.sidebar-content { padding: 14px 20px; height: 100%; }
.select-place-prompt { color: red; width: 100px; }
.carousel-container { position: relative; }
.carousel-inner { position: relative; overflow: hidden; }
.carousel-item { display: none; }
.carousel-item.active { display: block; }
.carousel-control-prev, .carousel-control-next {
  position: absolute; top: 50%; transform: translateY(-50%);
  font-size: 2rem; background: rgba(0,0,0,0.2); border: none; color: white; padding: 0 10px; cursor: pointer;
}
.carousel-control-prev { left: 0; }
.carousel-control-next { right: 0; }
</style>
</head>
<body>
<div id="sidebar"><div id="sidebar-app"></div></div>
<div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js"></script>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="/static/leaflet-sidebar.js"></script>
<script src="https://unpkg.com/@ansur/leaflet-pulse-icon@0.1.1/dist/L.Icon.Pulse.js"></script>

<script id="app-template" type="text/template">
<div :class="{'sidebar-content': 1, 'bg-white': selectedPlace, 'bg-secondary': !selectedPlace}">
  <div v-if="promptVisible" class="d-flex flex-column justify-content-center align-items-center" style="height: 100%;">
    <img class="d-block select-place-prompt mb-4" src="/static/hand-pointer-regular.svg" alt="Select place">
    <h4>Выберите место на карте</h4>
  </div>

  <div class="place-description" v-if="selectedPlace">
    <!-- Первая фотография отдельно -->
    <img v-if="mainPhotoSrc" :src="mainPhotoSrc" class="d-block shadow mb-3 rounded" :alt="selectedPlace.title">

    <h5 class="mb-3">{{ selectedPlace.title }}</h5>
    <p>{{ selectedPlace.short_description }}</p>

    <!-- Карусель только для оставшихся фотографий -->
    <div v-if="carouselImgs.length" class="carousel-container mb-3 shadow">
      <div class="carousel-inner">
        <div v-for="(img, index) in carouselImgs" :key="img" class="carousel-item" :class="{active: index === currentSlide}">
          <img :src="img" class="d-block w-100" :alt="selectedPlace.title">
        </div>
      </div>
      <button class="carousel-control-prev" @click="prevSlide">‹</button>
      <button class="carousel-control-next" @click="nextSlide">›</button>
    </div>

    <div v-html="selectedPlace.long_description"></div>
  </div>
</div>
</script>

<script>
var map = L.map('map').setView([55.753989, 37.623191], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
var sidebar = L.control.sidebar('sidebar', { closeButton: true, position: 'right' });
map.addControl(sidebar);

var sidebarApp = new Vue({
  el: '#sidebar-app',
  template: document.getElementById('app-template').innerHTML,
  data: {
    loadingPlaceId: null,
    selectedPlace: null,
    currentSlide: 0
  },
  computed: {
    promptVisible() { return !this.loading && !this.selectedPlace; },
    loading() { return this.loadingPlaceId !== null; },
    mainPhotoSrc() { return this.selectedPlace?.imgs?.[0] || null; },
    carouselImgs() { return this.selectedPlace?.imgs?.slice(1) || []; }
  },
  watch: {
    selectedPlace() { this.currentSlide = 0; } // Сбрасываем карусель при смене места
  },
  methods: {
    nextSlide() {
      if (!this.carouselImgs.length) return;
      this.currentSlide = (this.currentSlide + 1) % this.carouselImgs.length;
    },
    prevSlide() {
      if (!this.carouselImgs.length) return;
      this.currentSlide = (this.currentSlide - 1 + this.carouselImgs.length) % this.carouselImgs.length;
    }
  }
});

map.on('click', function () {
  sidebarApp.selectedPlace = null;
  sidebarApp.loadingPlaceId = null;
});

// Загружаем места с API
async function loadPlaces() {
  let response = await fetch('/api/places/');
  if (!response.ok) return;
  let places = await response.json();

  places.forEach(place => {
    let lat = place.coordinates?.lat;
    let lng = place.coordinates?.lng;
    if (lat == null || lng == null) return;

    let pulsingIcon = L.icon.pulse({ iconSize:[12,12], color:'red', fillColor:'red', heartbeat:2.5 });
    let marker = L.marker([lat, lng], { icon: pulsingIcon, riseOnHover:true });

    marker.bindTooltip(place.title);
    marker.on('click', () => {
      sidebar.show();
      sidebarApp.selectedPlace = {
        title: place.title,
        imgs: place.imgs || [],
        short_description: place.description_short,
        long_description: place.description_long
      };
    });

    marker.addTo(map);
  });
}

loadPlaces();
</script>
</body>
</html>
